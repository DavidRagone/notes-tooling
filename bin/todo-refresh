#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail
HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
. "$HERE/lib.sh"

ensure_dir "$TODO_DIR"
OUT="$TODO_DIR/TODO.md"

{
  echo "# Open Tasks"
  echo
  # Find unchecked boxes, print with file path for context.
  # Exclude the todo file itself and common non-note dirs.
  rg --no-ignore-vcs --hidden --glob '!**/.git/**' --glob '!**/.index/**' \
     --glob '!todo/TODO.md' -n '^\s*-\s*\[ \]\s' "$NOTES_DIR" \
  | while IFS=: read -r file line text; do
      rel="$(relpath "$file" "$TODO_DIR")"
      # strip leading checkmark and whitespace
      task="$(printf '%s' "$text" | sed -E 's/^\s*-\s*\[ \]\s*//')"
      printf "- [ ] %s  _(in [%s](%s#L%s))_\n" "$task" "$(basename "$file")" "$rel" "$line"
    done
  echo
} > "$OUT"

echo "Wrote $OUT"

