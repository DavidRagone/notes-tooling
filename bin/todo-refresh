#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail
HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
. "$HERE/lib.sh"

ensure_dir "$TODO_DIR"
OUT="$TODO_DIR/TODO.md"

# Initialize the file with header if it doesn't exist
if [[ ! -f "$OUT" ]]; then
  {
    echo "# Open Tasks"
    echo
  } > "$OUT"
fi

# Collect new todos
tmp_new="$(mktemp)"
trap 'rm -f "$tmp_new"' EXIT

# Find unchecked boxes, print with file path for context.
# Exclude the todo file itself and common non-note dirs.
# Only match todos that have actual text after the brackets (exclude empty template todos like "- [ ] ")
rg --no-ignore-vcs --hidden --glob '!**/.git/**' --glob '!**/.index/**' \
   --glob '!**/.tooling/**' --glob '!**/todo/TODO.md' -n '^\s*-\s*\[ \]\s*\S' "$NOTES_DIR" 2>/dev/null \
| while IFS=: read -r file line text; do
    rel="$(relpath "$file" "$TODO_DIR")"
    base="$(basename "$file")"
    # strip leading checkbox+whitespace
    task="$(printf '%s' "$text" | sed -E 's/^[[:space:]]*-[[:space:]]*\[[[:space:]]\][[:space:]]*//;s/^[[:space:]]*//')"
    # Use a single formatted string to avoid %-expansion surprises on old Bash
    todo_line="$(printf -- '- [ ] %s  _(in [%s](%s#L%s))_' "${task}" "${base}" "${rel}" "${line}")"
    
    # Check if this exact todo line already exists in the file
    if ! grep -qFx -- "$todo_line" "$OUT" 2>/dev/null; then
      echo "$todo_line"
    fi
  done > "$tmp_new"

# Append new todos and count them
added_count=0
if [[ -s "$tmp_new" ]]; then
  while IFS= read -r todo_line; do
    echo "$todo_line" >> "$OUT"
    added_count=$((added_count + 1))
  done < "$tmp_new"
fi

if [[ $added_count -gt 0 ]]; then
  if [[ $added_count -eq 1 ]]; then
    echo "Added $added_count new todo to $OUT"
  else
    echo "Added $added_count new todos to $OUT"
  fi
else
  echo "No new todos found (file is up to date)"
fi
